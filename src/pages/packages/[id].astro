---
import { getAllPackages, getPackageById, getPackageImages } from '@/lib/astro-supabase';
import Layout from '@/layouts/Layout.astro';
import PackageHero from '@/components/astro/PackageHero.astro';
import PackageDetails from '@/components/astro/PackageDetails.astro';
import ImageGallery from '@/components/astro/ImageGallery.astro';
import Footer from '@/components/astro/Footer.astro';

export async function getStaticPaths() {
  const packages = await getAllPackages();
  return packages.map((pkg) => ({
    params: { id: pkg.id },
  }));
}

const { id } = Astro.params;
const pkg = await getPackageById(id!);

if (!pkg) {
  return Astro.redirect('/404');
}

const images = pkg.folderPath ? await getPackageImages(pkg.folderPath) : [];

const title = `${pkg.title} - SnapFinder 제주 스냅 촬영`;
const description = pkg.details 
  ? `${pkg.details.slice(0, 150)}...` 
  : `제주도에서 ${pkg.title} 촬영을 경험해보세요. ${pkg.duration} 동안 진행되며 ₩${pkg.price.toLocaleString()}입니다.`;
---

<Layout title={title} description={description}>
  <main>
    <PackageHero 
      title={pkg.title}
      thumbnailUrl={pkg.thumbnailUrl}
      price={pkg.price}
      duration={pkg.duration}
      occasions={pkg.occasions}
      reservationUrl={pkg.reservationUrl}
    />
    
    {pkg.details && (
      <PackageDetails details={pkg.details} />
    )}
    
    {images.length > 0 && (
      <ImageGallery 
        images={images} 
        packageTitle={pkg.title} 
      />
    )}
  </main>

  <Footer />
</Layout>

<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Service",
  "name": pkg.title,
  "description": pkg.details || `제주도 ${pkg.title} 촬영 서비스`,
  "provider": {
    "@type": "LocalBusiness",
    "name": "SnapFinder 제주 스냅 촬영"
  },
  "areaServed": "제주특별자치도",
  "serviceType": "Photography",
  "offers": {
    "@type": "Offer",
    "price": pkg.price,
    "priceCurrency": "KRW",
    "availability": "https://schema.org/InStock"
  },
  "image": pkg.thumbnailUrl,
  "url": `https://your-site-url.com/packages/${pkg.id}`
})} />
</Layout>